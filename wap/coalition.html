<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>联盟商家代理</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=7e62760db2e3b0b1d9bde5bf408b7662"></script>
		<script type="text/javascript" src="http://webapi.amap.com/demos/js/liteToolbar.js"></script>
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=C93b5178d7a8ebdb830b9b557abce78b"></script>
		<link rel="stylesheet" type="text/css" href="css/reset.css" />
		<link rel="stylesheet" type="text/css" href="css/coalition.css" />
		<link rel="stylesheet" type="text/css" href="css/swiper-3.3.1.min.css" />
		<link rel="stylesheet" type="text/css" href="css/footer.css" />
	</head>
	<style type="text/css">
		.c-address {
			/*border: 1px solid red;*/
			/*font-size: 2.2rem;*/
		}
		
		.c-address img {
			width: 3.2rem;
		}
	</style>

	<body>
		<div class="c-wrap">
			<div class="c-tab">
				<div class="c-tab1">
					<!--<span class="c-address"></span>-->
					<span class="c-address">定位中
						<img src="images/5-121204194026.gif"/>
					</span>
					<img class="c-drop" src="images/z-9.png" alt="图片" />
					<div class="c-inputs">
						<img class="c-seach" src="images/z-10.png" />
						<input class="c-input" type="" name="" id="" value="" placeholder="输入商家" />
					</div>
					<img class="c-news" src="images/z-23.png" />
				</div>
			</div>
			<div class="swiper-container z-con">
				<div class="swiper-wrapper">
					<div class="swiper-slide">
						<ul class="c-classify c-clas1">
						</ul>
						<ul class="c-classify c-clas2">
						</ul>
					</div>
					<div class="swiper-slide">
						<ul class="c-classify c-clas3">
						</ul>
						<ul class="c-classify c-clas4">
						</ul>
					</div>
					<div class="swiper-slide">
						<ul class="c-classify c-clas5">
						</ul>
						<ul class="c-classify c-clas6">
						</ul>
					</div>
					<div class="swiper-slide">
						<ul class="c-classify c-clas7">
						</ul>
						<ul class="c-classify c-clas8">
						</ul>
					</div>
				</div>
				<!--分页器 -->
				<div class="swiper-pagination"></div>
				<div class="swiper-pagination"></div>
				<div class="swiper-pagination"></div>
			</div>
			<div class="c-middle"></div>
			<div class="c-near">
				<img src="images/z-12.png" />
				<span>附近的商家</span>
			</div>
			<div class="z-seller">
			</div>
			<div class="z-load"><img src="images/add.gif" /></div>
		</div>
		<div id="container"></div>
		<div class="footer">
			<a class="Index" href="index.html?coa"><img src="images/souye.png" alt=""></a>
			<a href="fenlei.html"><img src="images/kinds.png" alt=""></a>
			<a href="coalition.html"><img src="images/union2.png" alt=""></a>
			<a href="member.html" class="lcf"><img src="images/wealth.png" alt=""></a>
			<a href="z-member.html" class="w_my"><img src="images/me.png" alt=""></a>
		</div>
		<div class="z-prompt5" style="display: none;"></div>
		<div class="z-prompt6" style="display: none;"></div>
	</body>
	<script type="text/javascript" src="js/jquery-2.2.3.min.js"></script>
	<script type="text/javascript" src="js/swiper-3.3.1.min.js"></script>
	<script type="text/javascript" src="js/box.js"></script>
	<script type="text/javascript" src="js/url.js"></script>
	<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
	<script src="js/wx_qrCode.js"></script>
	<script type="text/javascript">
		$(function() {
			$(".Index").click(function() {
				window.location.href = "index.html";
			})
			wxInity('/wap/coalition.html');
			/*
	//微信扫一扫开始
	wx.config({
    debug: false,
    appId: 'wx10a59d3bf7f7f692',
    timestamp: '1478075518',
    nonceStr: 'DaP43TjEgiV6rqA5',
    signature: '2a84cf207291cdc8a5f81ed5d8a00e5de9ad7937',
    jsApiList: [
        'checkJsApi',
        'scanQRCode',
    ]
  });

  wx.ready(function () {
    // 在这里调用 API
  });
  */
			var tokens = localStorage.getItem("token");
			var types = localStorage.getItem("type");
			$(".c-news").click(function() {
				if(tokens == null) {
					$(".z-prompt5").html("请先登录").show();
					setTimeout(function() {
						$(".z-prompt5").hide();
					}, 1000);
					setTimeout(function() {
						window.location.href = "denglu.html"
					}, 1500);

				} else {
					saoyisao();
				}
				/*
 	wx.scanQRCode({
    needResult: 0, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
    scanType: ["qrCode","barCode"], // 可以指定扫二维码还是一维码，默认二者都有
    success: function (res) {
    var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
    }
    });
    */
			});
			if(types == 1) {
				$(".w_my").attr("href", "z-member.html");
			} else if(types == 2) {
				$(".w_my").attr("href", "z-unicon.html");
			} else if(types == 3) {
				$(".w_my").attr("href", "z-sell.html");
			} else if(types == 4) {
				$(".w_my").attr("href", "z-comm.html");
			} else if(types == 5) {
				$(".w_my").attr("href", "z-county.html");
			} else if(types == 6) {
				$(".w_my").attr("href", "z-city.html");
			} else if(types == 7) {
				$(".w_my").attr("href", "z-provin.html");
			}
			if(types == 1) {
				$(".lcf").attr("href", "jfmember.html");
			} else {
				$(".lcf").attr("href", "jffortune.html");
			}
			$(".c-inputs").click(function() {
				location.href = "union-history-seach.html";
			});
			$(".c-address").click(function() {
				location.href = "z-citiy.html";
			});
			$(".c-classify > li").each(function() {
				$(this).click(function() {
					location.href = "z-shop-local.html";
				});
			});
			//定位开始
			//首页轮播图结束
			var lnglatXY = [];
			var zzadds;
			//定位结束
			var tokens = localStorage.getItem("token");
			var lgts = localStorage.getItem("lgt");
			var lats = localStorage.getItem("lat");
			var zadds = localStorage.getItem("zadd");
			var storeArr = [];
			var datas;
			var storeId = [];
			var num;
			//百度api定位开始
			var map = new BMap.Map();
			var point = new BMap.Point();
			var geolocation = new BMap.Geolocation();
			geolocation.getCurrentPosition(function(r) {
					if(this.getStatus() == BMAP_STATUS_SUCCESS) {
//						if(lgtss)
						lgts = r.point.lng;
						lats = r.point.lat;
						localStorage.setItem('zlgt', r.point.lng);
						localStorage.setItem('zlat', r.point.lat);
//						lgtss = r.point.lng;
//						latss = r.point.lat;
						lnglatXY = [r.point.lng, r.point.lat];
						zhuanhuan();
					} else {
						//alert('failed' + this.getStatus());
					}
				}, {
					enableHighAccuracy: true
				})
				//百度api定位结束				
			var map = new AMap.Map('container', {}); //地图上所标点的坐标
			function zhuanhuan() {
				AMap.plugin('AMap.Geocoder', function() {
					var geocoder = new AMap.Geocoder({
						city: "010" //城市，默认：“全国”
					});
					var marker = new AMap.Marker({
						map: map,
						bubble: true
					})
					geocoder.getAddress(lnglatXY, function(status, result) {
						if(status === 'complete' && result.info === 'OK') {
							//console.log(result.regeocode.formattedAddress);
							var zaddress = result.regeocode.formattedAddress;
							//							console.log(zaddress)
							if(zaddress) {
								var zzadds = zaddress.substr(3, 6);
								var zadd = zzadds.substr(0, 3);
								localStorage.setItem('zaddsa11', zadd);
								if(zadds == null) {
									$(".c-address").html(zadd);
								} else {
									var zaddsa = zadds.substr(0, 3);
									$(".c-address").text(zaddsa);
								}
							}

						} else {

						}
					})

				});
			}
			//百度api定位结束
			var lgtss = localStorage.getItem("zlgt");
			var latss = localStorage.getItem("zlat");

			// 	商铺ajax
			$.ajax({
				//contentType:"application/x-www-form-urlencoded; charset=gb2312",
				type: 'POST',
				url: Url + "api/index.php?n=store&f=storeclass",
				dataType: "json",
				data: {},
				success: function(data) {
					datas = data.data;
					//					console.log(datas)
					for(var i = 0; i < datas.length; i++) {
						storeArr.push(datas[i].cate_name);
					}
					for(var i = 0; i < 4; i++) {
						var html1 = '<li><span><img src="' + Url + '' + datas[i].thumb + '"/></span><p>' + datas[i].cate_name + '</p></li>';
						$(".c-clas1").append(html1);
					}
					for(var i = 4; i < 8; i++) {
						var html1 = '<li><span><img src="' + Url + '' + datas[i].thumb + '"/></span><p>' + datas[i].cate_name + '</p></li>';
						$(".c-clas2").append(html1);
					}
					for(var i = 8; i < 12; i++) {
						var html1 = '<li><span><img src="' + Url + '' + datas[i].thumb + '"/></span><p>' + datas[i].cate_name + '</p></li>';
						$(".c-clas3").append(html1);
					}
					for(var i = 12; i < 16; i++) {
						var html1 = '<li><span><img src="' + Url + '' + datas[i].thumb + '"/></span><p>' + datas[i].cate_name + '</p></li>';
						$(".c-clas4").append(html1);
					}
					for(var i = 16; i < 20; i++) {
						var html1 = '<li><span><img src="' + Url + '' + datas[i].thumb + '"/></span><p>' + datas[i].cate_name + '</p></li>';
						$(".c-clas5").append(html1);
					}
					for(var i = 20; i < 24; i++) {
						var html1 = '<li><span><img src="' + Url + '' + datas[i].thumb + '"/></span><p>' + datas[i].cate_name + '</p></li>';
						$(".c-clas6").append(html1);
					}
					for(var i = 24; i < 25; i++) {
						var html1 = '<li><span><img src="' + Url + '' + datas[i].thumb + '"/></span><p>' + datas[i].cate_name + '</p></li>';
						$(".c-clas7").append(html1);
					}

					//					var leng = datas.length;
					//					console.log(leng);
					//					var lengs = Math.ceil(leng / 8)
					//					console.log(lengs);
					//					for (var j = 0; j < lengs; j++) {
					//						var htmlz = '<div class="swiper-slide"><ul class="c-classify c-clas1"></ul><ul class="c-classify c-clas2"></ul></div>';
					//					}
					//					for (var i = 28; i < 32; i++) {
					//						var html1 = '<li><span><img src="' + Url + '' + datas[i].thumb + '"/></span><p>' + datas[i].cate_name + '</p></li>';
					//						$(".c-clas8").append(html1);
					//					}
					//					var html = '<div class="swiper-slide"><ul class="c-classify"><li><span><img src="' + Url + '' + datas[0].thumb + '"/></span><p>' + datas[0].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[1].thumb + '"/></span><p>' + datas[1].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[2].thumb + '"/></span><p>' +
					//						datas[2].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[3].thumb + '"/></span><p>' + datas[3].cate_name + '</p></li></ul><ul class="c-classify c-classify1"><li><span><img src="' + Url + '' + datas[4].thumb + '"/></span><p>' + datas[4].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[5].thumb + '"/></span><p>' +
					//						datas[5].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[6].thumb + '"/></span><p>' + datas[6].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[7].thumb + '"/></span><p>' + datas[7].cate_name + '</p></li></ul></div><div class="swiper-slide"><ul class="c-classify"><li><span><img src="' + Url + '' + datas[8].thumb + '"/></span><p>' +
					//						datas[8].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[9].thumb + '"/></span><p>' + datas[9].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[10].thumb + '"/></span><p>' + datas[10].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[11].thumb + '"/></span><p>' +
					//						datas[11].cate_name + '</p></li></ul><ul class="c-classify"><li><span><img src="' + Url + '' + datas[12].thumb + '"/></span><p>' + datas[12].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[13].thumb + '"/></span><p>' + datas[13].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[14].thumb + '"/></span><p>' +
					//						datas[14].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[15].thumb + '"/></span><p>' + datas[15].cate_name + '</p></li></ul></div><div class="swiper-slide"><ul class="c-classify"><li><span><img src="' + Url + '' + datas[16].thumb + '"/></span><p>' + datas[16].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[17].thumb + '"/></span><p>' +
					//						datas[17].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[18].thumb + '"/></span><p>' + datas[18].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[19].thumb + '"/></span><p>' + datas[19].cate_name + '</p></li></ul><ul class="c-classify"><li><span><img src="' + Url + '' + datas[20].thumb + '"/></span><p>' +
					//						datas[20].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[21].thumb + '"/></span><p>' + datas[21].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[22].thumb + '"/></span><p>' + datas[22].cate_name + '</p></li><li><span><img src="' + Url + '' + datas[23].thumb + '"/></span><p>' + datas[23].cate_name + '</p></li></ul></div>';
					//					$(".swiper-wrapper").html(html);

					var mySwiper = new Swiper('.swiper-container', {
						direction: 'horizontal',
						autoplay: 3000,
						loop: true,
						pagination: '.swiper-pagination',
						paginationClickable: true,
					});
					$(".c-classify > li").each(function() {
						$(this).click(function() {
							var loval = $(this).text();
							localStorage.setItem('lovals', loval);
							location.href = "z-shop-local.html";
						});
					});
				},
				error: function(data) {　　}
			});

			//附近的商家ajax开始
			$(".z-load").show();
			$.ajax({
				//contentType:"application/x-www-form-urlencoded; charset=gb2312",
				type: 'POST',
				url: Url + "api/index.php?n=store&f=nearbyshops",
				dataType: "json",
				data: {
					"lat": lats,
					"lng": lgts,
					"page": 1
				},
				success: function(data) {
					//console.log(data)
					datas = data.data;
					num = data.totalpage;
					var html = '';
					var dis = '';
					var disn = '';
					for(var i = 0; i < datas.length; i++) {
						var lgt = datas[i].lng;
						var lat = datas[i].lat;
						var map = new BMap.Map();
						var pointA = new BMap.Point(lgtss, latss); // 创建点坐标A
						var pointB = new BMap.Point(lgt, lat); // 创建点坐标B
						//						console.log((map.getDistance(pointA, pointB)).toFixed(2));
//						console.log(pointA);
//						console.log(pointB);
						var distance = (map.getDistance(pointA, pointB)).toFixed(2);
//						console.log(distance);
						dis = distance / 1000;
//						console.log(dis);
						disn = dis.toFixed(2);
						//计算距离结束
						html = '<ul class="c-seller"><li><img class="z-cimg" src="' + Url + '' + datas[i].store_logo + '"/><span class="z-logo"></span><span class="z-sell"></span><span class="is_good">' + datas[i].is_good + '</span><span class="is_trade">' + datas[i].is_trade + '</span></li><li><span class="z-stname">' + datas[i].store_name + '</span><p>' + datas[i].cate_name + '</p></li><li><span class="z-distance">' + disn + 'km</span><p class="c-adds">地址：' + datas[i].address + '</p></li></ul>';
						$(".z-seller").append(html);
						storeId.push(datas[i].store_id);
						//计算距离开始
					}
					IsgoodFn();
					IstradeFn();
					$('.z-cimg').error(function() {
						$(this).attr('src', 'images/z-logo.png');
					});
					word(9);
					storew(6)
					$(".c-seller").each(function() {
						$(this).click(function() {
							var a = $(this).index();
							var stid = storeId[a];
							localStorage.setItem('stid', stid);
							location.href = "lmsjdpxq.html";
						})
					});
					setTimeout(function() {
						$(".z-load").hide();
					}, 300)
				},
				error: function(data) {　　}
			});
			//  附近的商家ajax结束

			//附近的商家分页开始
			var pages = 1; //当前页的页码
			var allpage = num; //总页码，会从后台获取
			var sc = true;

			function showAjax() {
				$(".z-load").show();
				$.ajax({
					//			contentType:"application/x-www-form-urlencoded; charset=gb2312",
					type: 'POST',
					url: Url + "api/index.php?n=store&f=nearbyshops",
					dataType: "json",
					data: {
						"lat": lats,
						"lng": lgts,
						"page": pages
					},
					success: function(data) {
						datas = data.data;
						//console.log(data.totalpage)
						var html = '';
						var dis;
						var disn;
						for(var i = 0; i < datas.length; i++) {
							var lgt = datas[i].lng;
//							console.log(lgt);
							var lat = datas[i].lat;
//							console.log(lat);
							var map = new BMap.Map();
							var pointA = new BMap.Point(lgtss, latss); // 创建点坐标A
							var pointB = new BMap.Point(lgt, lat); // 创建点坐标B
							//							console.log((map.getDistance(pointA, pointB)).toFixed(2));
							var distance = (map.getDistance(pointA, pointB)).toFixed(2);
							dis = distance / 1000;
							disn = dis.toFixed(2);
							html = '<ul class="c-seller"><li><img class="z-cimg" src="' + Url + '' + datas[i].store_logo + '"/><span class="z-logo"></span><span class="z-sell"></span><span class="is_good">' + datas[i].is_good + '</span><span class="is_trade">' + datas[i].is_trade + '</span></li><li><span class="z-stname">' + datas[i].store_name + '</span><p>' + datas[i].cate_name + '</p></li><li><span class="z-distance">' + disn + 'km</span><p class="c-adds">地址：' + datas[i].address + '</p></li></ul>';
							sc = true;
							$(".z-seller").append(html);
							storeId.push(datas[i].store_id);
						}
						IsgoodFn();
						IstradeFn();
						$('.z-cimg').error(function() {
							$(this).attr('src', 'images/z-logo.png');
						});
						word(9);
						storew(6)
						$(".c-seller").each(function() {
							$(this).click(function() {
								var a = $(this).index();
								var stid = storeId[a];
								localStorage.setItem('stid', stid);
								location.href = "lmsjdpxq.html";
							})
						});
						setTimeout(function() {
							$(".z-load").hide();
						}, 300)
					},
					error: function(data) {}
				});
			}
			//附近的商家分页结束
			function scrollFn() {
				//真实内容的高度
				var pageHeight = Math.max(document.body.scrollHeight, document.body.offsetHeight);
				//视窗的高度
				// console.log(pageHeight);
				var viewportHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight || 0;
				// console.log(viewportHeight);
				//隐藏的高度
				var scrollHeight = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
				// console.log(scrollHeight);
				if(pageHeight - viewportHeight - scrollHeight < 10) { //如果满足触发条件，执行
					if(sc) {
						sc = false;
						pages++;
						if(pages <= num) {
							showAjax();
						}

					}
				}
			}
			$(window).bind("scroll", scrollFn); //绑定滚动事件  
			//判断是否优质开始
			function IsgoodFn() {
				$(".is_good").each(function() {
					var good = $(this).text();
					if(good == 0) {
						$(this).siblings(".z-sell").hide();
					}
					if(good == 1) {
						$(this).siblings(".z-sell").show();
					}
				})
			}
			//判断是否优质结束

			//判断是否允许交易开始
			function IstradeFn() {
				$(".is_trade").each(function() {
					var trade = $(this).text();
					if(trade == 0) {
						$(this).siblings(".z-logo").hide();
					}
					if(trade == 1) {
						$(this).siblings(".z-logo").show();
					}
				})
			}
			//判断是否允许交易结束
			//限制地址字数方法
			function word(len) {
				$(".c-adds").each(function() {
					var counter = $(this).text().length; //获取文本域的字符串长度
					var txt = $(this).text();
					if(counter >= len) {
						var num = $(this).text().substr(0, len);
						$(this).text(num + '....');
					} else {
						$(this).text(txt);
					}
				});
			}
			//限制商家名字数方法
			function storew(slen) {
				$(".z-stname").each(function() {
					var counter = $(this).text().length; //获取文本域的字符串长度
					var txt = $(this).text();
					if(counter >= slen) {
						var num = $(this).text().substr(0, slen);
						$(this).text(num + '....');
						//		alert("你已经超过字数限制");
					} else {
						$(this).text(txt);
					}
				});
			}
			//改变地址
			//			if($(".c-address").text() == "") {
			//				$(".c-address").text("北京");
			//			}
			// if(zadds >= 5){
			//	var zaddsa = zadds.substr(3, 6);
			// }

		});
	</script>

</html>